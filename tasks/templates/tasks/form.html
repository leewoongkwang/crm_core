{% extends "base.html" %}
{% load form_tags %}
{% load custom_filters %}

{% block title %}í•˜ë£¨ ì—…ë¬´ ê¸°ë¡{% endblock %}
{% block page_title %}í•˜ë£¨ ì—…ë¬´ ê¸°ë¡ (KPI + ê³ ê° ì ‘ì´‰){% endblock %}

{% block content %}

<!-- âœ… KPI 2ì—´ êµ¬ì„±: ì¢Œì¸¡ ì¼ì¼ ì§„í–‰ë¥  + ìš°ì¸¡ ì£¼ê°„ ì§„í–‰ë¥  -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">

  <!-- ì¢Œì¸¡: ì¼ì¼ KPI ì§„í–‰ë¥  + ì—…ë‹¤ìš´ -->
  <section class="bg-white p-6 rounded shadow">
    <h2 class="text-lg font-bold mb-4">ğŸ“Š ì˜¤ëŠ˜ KPI ì§„í–‰ë¥ </h2>
    {% for card in progress_cards %}
    <div class="mb-4">
      <div class="flex justify-between items-center mb-1">
        <span>{{ card.label }} ({{ card.value }}/{{ card.target }})</span>
        <div class="flex items-center gap-1">
          <form method="post" action="{% url 'tasks:adjust_kpi' %}">
            {% csrf_token %}
            <input type="hidden" name="field" value="{{ card.field }}">
            <input type="hidden" name="adjustment" value="up">
            <button type="submit" class="text-xs px-1 bg-gray-200 rounded">&#9650;</button>
          </form>
          <form method="post" action="{% url 'tasks:adjust_kpi' %}">
            {% csrf_token %}
            <input type="hidden" name="field" value="{{ card.field }}">
            <input type="hidden" name="adjustment" value="down">
            <button type="submit" class="text-xs px-1 bg-gray-200 rounded">&#9660;</button>
          </form>
        </div>
      </div>
      <div class="w-full bg-gray-200 rounded h-3">
        <div class="{{ card.css }} h-3 rounded" style="width: {{ card.percent|floatformat:0|default:0 }}%; max-width: 100%"></div>
      </div>
    </div>
    {% endfor %}
  </section>

  <!-- ìš°ì¸¡: ì£¼ê°„ KPI ì§„í–‰ë¥  (ì½ê¸° ì „ìš©) -->
  <section class="bg-white p-6 rounded shadow">
    <h2 class="text-lg font-bold mb-4">ğŸ“ˆ ì£¼ê°„ KPI ì§„í–‰ë¥ </h2>
    {% for card in weekly_progress_cards %}
    <div class="mb-4">
      <div class="flex justify-between mb-1">
        <span>{{ card.label }} ({{ card.value }}/{{ card.target }})</span>
        <span>{{ card.percent }}%</span>
      </div>
      <div class="w-full bg-gray-200 rounded h-3">
        <div class="{{ card.css }} h-3 rounded" style="width: {{ card.percent|floatformat:0|default:0 }}%; max-width: 100%"></div>
      </div>
    </div>
    {% endfor %}
  </section>

</div>

<!-- ğŸ§‘ ê³ ê° í„°ì¹˜ ë¦¬ìŠ¤íŠ¸ -->
<section class="bg-white p-6 rounded shadow mb-6">
  <h2 class="text-lg font-bold mb-4">ğŸ“Œ ì˜¤ëŠ˜ì˜ ê³ ê° ì ‘ì´‰</h2>
  <table class="w-full table-auto text-sm">
    <thead class="bg-gray-100">
      <tr>
        <th class="py-2 px-4 text-left">ì´ë¦„</th>
        <th class="py-2 px-4 text-left">ë‹¨ê³„ ì§„í–‰</th>
        <th class="py-2 px-4 text-left">ì•¡ì…˜</th>
      </tr>
    </thead>
    <tbody>
      {% for c in touch_tasks %}
      <tr class="border-t">
        <td class="py-2 px-4 font-medium">{{ c.name }}</td>
        <!-- ë‹¨ê³„ ì‹œê°í™” -->
        <td class="py-2 px-4">
          <div class="flex items-center">
            {% for step_key, step_label in step_sequence %}
              <div class="flex flex-col items-center w-12 text-[11px] text-center relative">
                <!-- â— ì›í˜• -->
                <div class="w-3 h-3 rounded-full mb-1 z-10
                  {% if step_key == c.current_touch_step %}
                    border-2 border-blue-700 bg-white
                  {% elif step_key in completed_steps_map.c.id %}
                    bg-blue-500
                  {% else %}
                    bg-gray-300
                  {% endif %}
                "></div>
              
                <!-- ë¼ë²¨ -->
                <div class="truncate text-gray-600">{{ step_label }}</div>
              </div>
            
              {% if not forloop.last %}
              <!-- ì„  ì—°ê²° -->
              <div class="h-0.5 w-4 
                {% if step_key in completed_steps_map.c.id %}
                  bg-blue-500
                {% else %}
                  bg-gray-300
                {% endif %}">
              </div>
              {% endif %}
            {% endfor %}
          </div>
        </td>
        
        <!-- ì•¡ì…˜ -->
        <td class="py-2 px-4">
          <form method="post" action="{% url 'tasks:advance_touch' %}" class="inline">
            {% csrf_token %}
            <input type="hidden" name="customer_id" value="{{ c.id }}">
            <button class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">ì§„í–‰</button>
          </form>

          <form method="post" action="{% url 'tasks:revert_touch' %}" class="inline ml-2">
            {% csrf_token %}
            <input type="hidden" name="customer_id" value="{{ c.id }}">
            <button class="px-2 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-600">ë˜ëŒë¦¬ê¸°</button>
          </form>

          <form method="post" action="{% url 'tasks:complete_touch' %}" class="inline ml-2">
            {% csrf_token %}
            <input type="hidden" name="customer_id" value="{{ c.id }}">
            <button class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">ì™„ë£Œ</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>



<!-- âœ… KPI íˆìŠ¤í† ë¦¬ -->
{% if kpi_history %}
<section class="bg-white p-6 rounded shadow mb-6">
  <h2 class="text-lg font-bold mb-4">ğŸ—‚ KPI íˆìŠ¤í† ë¦¬</h2>
  <table class="w-full table-auto text-sm">
    <thead class="bg-gray-100">
      <tr>
        <th class="py-2 px-4">ë‚ ì§œ</th>
        <th class="py-2 px-4">1ë¶„</th>
        <th class="py-2 px-4">2ë¶„</th>
        <th class="py-2 px-4">ì œì•ˆ</th>
        <th class="py-2 px-4">ë°©ë¬¸</th>
        <th class="py-2 px-4">ê°€ë§</th>
        <th class="py-2 px-4">ë°´ë“œ</th>
      </tr>
    </thead>
    <tbody>
      {% for a in kpi_history %}
      <tr class="border-t">
        <td class="py-2 px-4">{{ a.date }}</td>
        <td class="py-2 px-4">{{ a.daily_call_1min }}</td>
        <td class="py-2 px-4">{{ a.daily_call_2min }}</td>
        <td class="py-2 px-4">{{ a.daily_proposals }}</td>
        <td class="py-2 px-4">{{ a.daily_visit_proposals }}</td>
        <td class="py-2 px-4">{{ a.daily_grade_potential }}</td>
        <td class="py-2 px-4">{{ a.daily_band_verified }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% endif %}

<!-- âœ… ê³ ê° ì ‘ì´‰ íˆìŠ¤í† ë¦¬ -->
{% if touch_history %}
<section class="bg-white p-6 rounded shadow">
  <h2 class="text-lg font-bold mb-4">ğŸ“‹ ê³ ê° ì ‘ì´‰ íˆìŠ¤í† ë¦¬</h2>
  <table class="w-full table-auto text-sm">
    <thead class="bg-gray-100">
      <tr>
        <th class="py-2 px-4">ê³ ê°ëª…</th>
        <th class="py-2 px-4">ë°©ì‹</th>
        <th class="py-2 px-4">ë©”ëª¨</th>
        <th class="py-2 px-4">ë‚ ì§œ</th>
      </tr>
    </thead>
    <tbody>
      {% for t in touch_history %}
      <tr class="border-t">
        <td class="py-2 px-4">{{ t.customer }}</td>
        <td class="py-2 px-4">{{ t.get_method_display }}</td>
        <td class="py-2 px-4">{{ t.memo|truncatechars:20 }}</td>
        <td class="py-2 px-4">{{ t.created_at|date:"Y-m-d H:i" }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% endif %}

{% endblock %}
