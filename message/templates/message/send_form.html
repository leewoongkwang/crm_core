{% extends "base.html" %}
{% block title %}ë©”ì‹œì§€ ì „ì†¡ í…ŒìŠ¤íŠ¸{% endblock %}
{% block page_title %}ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ ì „ì†¡ ìš”ì²­{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto bg-white p-6 rounded shadow">

  <!-- âœ… ì „ì†¡ í”„ë¡œê·¸ë¨ ì„¤ì¹˜ ì•ˆë‚´ (ê¸°ë³¸ ìˆ¨ê¹€) -->
  <div id="install-guide" class="hidden bg-yellow-100 border-l-4 border-yellow-500 p-4 mb-6">
    <h3 class="font-bold text-yellow-800 mb-1">ğŸ”§ ì „ì†¡ í”„ë¡œê·¸ë¨ ì„¤ì¹˜ í•„ìš”</h3>
    <p class="text-sm text-yellow-700">
      ì „ì†¡ í”„ë¡œê·¸ë¨ì´ ì„¤ì¹˜ë˜ì§€ ì•Šì€ ê²½ìš° ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì„¤ì¹˜ë¥¼ ì§„í–‰í•˜ì„¸ìš”.<br>
      ì„¤ì¹˜ í›„ í”„ë¡œê·¸ë¨ì€ ìë™ìœ¼ë¡œ ì¢…ë£Œë˜ë©°, ë¸Œë¼ìš°ì €ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
    </p>
    <a href="http://3.38.7.3:8000/static/download/setup_kakao_launcher.bat" download
       onclick="alert('ğŸ“¥ ì„¤ì¹˜ í”„ë¡œê·¸ë¨ì´ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.\\nì••ì¶• ì—†ì´ ë°”ë¡œ ì‹¤í–‰í•´ì£¼ì„¸ìš”.')"
       class="inline-block bg-blue-600 text-white font-semibold px-4 py-2 rounded hover:bg-blue-700 mt-2">
      ğŸš€ ì „ì†¡ í”„ë¡œê·¸ë¨ ì„¤ì¹˜í•˜ê¸°
    </a>
    <p class="text-xs text-gray-500 mt-2">
      âš  ë³¸ ì„¤ì¹˜íŒŒì¼ì€ ë©”ì‹œì§€ ìë™ ì „ì†¡ì„ ìœ„í•œ í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤. ì»´í“¨í„°ì— ì˜í–¥ì„ ì£¼ì§€ ì•Šìœ¼ë©°, ì–¸ì œë“  ì‚­ì œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
    </p>
  </div>

  {% if messages %}
    <ul class="mb-4">
      {% for message in messages %}
        <li class="text-green-600">{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <form method="POST" action="{% url 'message:send' %}" class="grid grid-cols-3 gap-6">
    {% csrf_token %}
    <input type="hidden" name="user_id" value="{{ request.user.id }}">
    <input type="hidden" name="host" value="3.38.7.3:8000">  <!-- ì‹¤ì œ host ê°’ -->
    <!-- ì¢Œì¸¡: ê³ ê° ë¦¬ìŠ¤íŠ¸ -->
    <div class="col-span-1 border rounded p-4 overflow-y-scroll h-[500px]">
      <h3 class="font-bold text-lg mb-2">ì „ì†¡ ëŒ€ìƒ ê³ ê°</h3>
      {% for customer in customers %}
        <label class="flex items-center space-x-2 mb-1">
          <input type="checkbox" name="recipients" value='{"id": {{ customer.id }}, "name": "{{ customer.name }}"}'>
          <span>{{ customer.name }} / {{ customer.gender }} / {{ customer.grade }}</span>
        </label>
      {% empty %}
        <p class="text-sm text-gray-400">í‘œì‹œí•  ê³ ê° ì—†ìŒ</p>
      {% endfor %}
    </div>

    <!-- ìš°ì¸¡: ë©”ì‹œì§€ ì…ë ¥ -->
    <div class="col-span-2 space-y-4">

      <div>
        <label class="block text-sm font-bold mb-1">ë©”ì‹œì§€ ë‚´ìš© ({{ ì´ë¦„ }} ì‚¬ìš© ê°€ëŠ¥)</label>
        <textarea name="message" class="w-full border px-3 py-2 rounded" rows="5" required>{{ request.POST.message|default_if_none:''|escape }}</textarea>
      </div>

      <div>
        <label class="block text-sm font-bold mb-1">ì´ë¯¸ì§€ URL (ì„ íƒ)</label>
        <input type="text" name="image_url" class="w-full border px-3 py-2 rounded" value="{{ request.POST.image_url|default_if_none:''|escape }}">
      </div>

      <!-- ì„¤ì¹˜ ìƒíƒœ í™•ì¸ + ì „ì†¡ ë²„íŠ¼ -->
      <div class="space-y-2">
        <button type="button" onclick="checkInstallStatus()" class="bg-yellow-500 text-white px-3 py-1 rounded">
          ğŸ” ì„¤ì¹˜ ìƒíƒœ í™•ì¸
        </button>
        <p id="sender-status-msg" class="text-sm text-gray-600"></p>

        <button
          type="button"
          id="send-btn"
          class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
          onclick="handleSendClick()"
        >
          ì „ì†¡ ìš”ì²­
        </button>
      </div>
    </div>
  <!-- âœ… ì‹¤ì‹œê°„ ì „ì†¡ ìƒíƒœ ì˜ì—­ -->
  <div id="status-board" class="mt-10 p-4 border rounded bg-gray-50">
    <h2 class="font-bold text-lg mb-4">ğŸ“¡ ì‹¤ì‹œê°„ ì „ì†¡ ìƒíƒœ</h2>
    <div id="status-list" class="space-y-4 text-sm text-gray-800">
      <div class="text-gray-500">â³ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤...</div>
    </div>
  </div>
  </form>
</div>

<script>
function checkInstallStatus() {
  window.location.href = "NHCRM://check-install";

  setTimeout(() => {
    fetch("{% url 'message:launcher_ping_latest' %}")
      .then(res => res.json())
      .then(data => {
        const sendBtn = document.getElementById("send-btn");
        const guide = document.getElementById("install-guide");
        const msgEl = document.getElementById("sender-status-msg");

        if (data.installed === "yes") {
          guide.classList.add("hidden");
          sendBtn.disabled = false;
          msgEl.textContent = "âœ… ì „ì†¡ í”„ë¡œê·¸ë¨ì´ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.";
          msgEl.className = "text-green-600 text-sm";
        } else {
          guide.classList.remove("hidden");
          sendBtn.disabled = true;
          msgEl.textContent = "âŒ ì „ì†¡ í”„ë¡œê·¸ë¨ì´ ì„¤ì¹˜ë˜ì§€ ì•Šì€ ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.";
          msgEl.className = "text-red-500 text-sm";
        }
      });
  }, 2000);
}
</script>
<script>
function handleSendClick() {
  const sendBtn = document.getElementById("send-btn");
  const form = sendBtn.closest("form");

  // 1ï¸âƒ£ ì‚¬ìš©ì IDì™€ host ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  const userId = form.querySelector('input[name="user_id"]').value;
  const host = form.querySelector('input[name="host"]').value;

  // 2ï¸âƒ£ launcher ì‹¤í–‰ (ì»¤ìŠ¤í…€ í”„ë¡œí† ì½œ)
  window.location.href = `NHCRM://${userId}/${host}`;

  // 3ï¸âƒ£ 1.5ì´ˆ í›„ í¼ ì œì¶œ
  setTimeout(() => {
    form.submit();
  }, 1500);
}
</script>
<script>
window.addEventListener("beforeunload", function () {
  fetch("/message/sender-shutdown-view?user_id={{ request.user.id }}");
});
</script>

<script>
const msgId = "{{ request.GET.message_id|default:'latest' }}";
const userId = "{{ request.user.id }}";

function pollRecipientStatus() {
  fetch(`/message/api/recipient-status?user_id=${userId}&message_id=${msgId}`)
    .then(res => res.json())
    .then(data => {
      const list = document.getElementById("status-list");
      list.innerHTML = "";

      if (data.length === 0) {
        list.innerHTML = "<div class='text-gray-400'>ğŸ“­ ì•„ì§ ìƒíƒœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
        return;
      }

      data.forEach(rec => {
        const color = rec.status === "sent" ? "green" : (rec.status === "failed" ? "red" : "yellow");
        const icon = rec.status === "sent" ? "âœ…" : (rec.status === "failed" ? "âŒ" : "â³");
        const statusText = rec.status === "sent" ? "ì „ì†¡ ì™„ë£Œ" : (rec.status === "failed" ? "ì „ì†¡ ì‹¤íŒ¨" : "ì „ì†¡ ì¤‘");

        const item = document.createElement("div");
        item.className = `border border-${color}-200 bg-white rounded p-3 shadow-sm`;

        item.innerHTML = `
          <div class="flex justify-between items-center">
          <div class="${color} font-semibold">
            ${icon} ${rec.name} <span class="text-xs text-gray-400">#${rec.customer_id}</span>
          </div>
            <span class="text-xs bg-${color}-100 text-${color}-800 px-2 py-1 rounded">${statusText}</span>
          </div>
          <button onclick="toggleLog('log-${rec.customer_id}')" class="text-blue-500 text-xs underline mt-1">â–¼ ìƒì„¸ ë¡œê·¸ ë³´ê¸°</button>
          <pre id="log-${rec.customer_id}" class="hidden bg-gray-50 border rounded mt-2 p-2 text-xs text-gray-700 whitespace-pre-wrap">${rec.reason}</pre>
        `;
        list.appendChild(item);
      });
    });
}

function toggleLog(id) {
  const el = document.getElementById(id);
  el.classList.toggle("hidden");
}

setInterval(pollRecipientStatus, 2000);
</script>

{% endblock %}
